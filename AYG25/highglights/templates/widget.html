<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Highlights Widget</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #fff;
            width: 1920px;
            height: 1080px;
            overflow: hidden;
            position: relative;
        }

        .widget-container {
            width: 1920px;
            height: 1080px;
            position: relative;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .header {
            background-color: #E30613;
            color: white;
            text-align: center;
            padding: 15px 0;
            font-size: 28px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 2px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .content {
            padding: 20px;
            max-width: 1880px;
            margin: 0 auto;
        }

        .section {
            border: 4px solid #E30613;
            margin: 20px 0;
            padding: 20px;
        }

        .title {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #000;
        }

        .subtitle {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            margin-top: 15px;
            margin-bottom: 10px;
            color: #000;
        }

        .event {
            font-size: 16px;
            font-weight: bold;
            margin: 15px 0 10px 0;
            color: #000;
        }

        .carousel-container {
            position: relative;
            margin: 10px 0;
            overflow: hidden;
            width: 100%;
        }

        .carousel-wrapper {
            display: flex;
            flex-wrap: nowrap;
            transition: transform 0.3s ease;
            gap: 15px;
            width: 100%;
        }

        .result-card {
            background-color: #FDE9E9;
            padding: 15px;
            border-radius: 5px;
            flex: 0 0 calc(50% - 7.5px);
            min-width: calc(50% - 7.5px);
            max-width: calc(50% - 7.5px);
            box-sizing: border-box;
        }

        .carousel-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: #E30613;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .carousel-nav:hover {
            opacity: 1;
        }

        .carousel-nav.prev {
            left: 10px;
        }

        .carousel-nav.next {
            right: 10px;
        }

        .carousel-nav:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .carousel-dots {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 10px;
        }

        .carousel-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #ccc;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .carousel-dot.active {
            background-color: #E30613;
        }

        /* H2H Styles */
        .h2h-match {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
        }

        .player {
            flex: 1;
            text-align: center;
        }

        .player-name {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .player-country {
            font-size: 12px;
            color: #666;
        }

        .player-score {
            font-size: 18px;
            font-weight: bold;
            margin-top: 8px;
        }

        .vs-divider {
            font-weight: bold;
            font-size: 16px;
            color: #E30613;
        }

        .medal-icon {
            display: inline-block;
            font-size: 20px;
            margin-left: 8px;
        }

        /* Non-H2H Styles */
        .non-h2h-result {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .athlete-info {
            flex: 1;
        }

        .athlete-name {
            font-weight: bold;
            font-size: 14px;
        }

        .result-value {
            font-size: 16px;
            font-weight: bold;
            margin-left: 20px;
        }

        .pb-badge {
            background: linear-gradient(135deg, #ff6b9d, #ff8fb3);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 8px;
        }

        .loading {
            text-align: center;
            padding: 100px 20px;
            font-size: 18px;
            color: #666;
        }

        .error {
            text-align: center;
            padding: 100px 20px;
            font-size: 18px;
            color: #E30613;
        }
    </style>
</head>
<body>
    <div class="widget-container">
        <div class="header">RESULTS</div>
        <div class="content" id="highlights-content">
            <div class="loading">Loading highlights...</div>
        </div>
    </div>

    <script>
        // Fetch highlights data from API
        const config = {{ config|tojson }};
        
        async function loadHighlights() {
            try {
                const params = new URLSearchParams({
                    spreadsheet_id: config.spreadsheet_id,
                    sheet_name: config.sheet_name
                });
                
                if (config.credentials_file) {
                    params.set('credentials_file', config.credentials_file);
                }
                if (config.date_filter) {
                    params.set('date', config.date_filter);
                }
                if (config.sport_filter) {
                    params.set('sport', config.sport_filter);
                }
                
                const response = await fetch(`/api/highlights?${params.toString()}`);
                const data = await response.json();
                
                if (data.error) {
                    document.getElementById('highlights-content').innerHTML = 
                        `<div class="error">Error: ${data.error}</div>`;
                    return;
                }
                
                renderHighlights(data);
            } catch (error) {
                document.getElementById('highlights-content').innerHTML = 
                    `<div class="error">Error loading highlights: ${error.message}</div>`;
            }
        }
        
        function renderHighlights(data) {
            const container = document.getElementById('highlights-content');
            let html = '';
            
            // Render H2H highlights
            if (data.h2h_groups && data.h2h_groups.length > 0) {
                data.h2h_groups.forEach(group => {
                    html += `<div class="section">`;
                    html += `<div class="title">${group.sport}</div>`;
                    html += `<div class="subtitle">${group.gender}</div>`;
                    
                    group.events.forEach(event => {
                        html += `<div class="event">${event.event}${event.stage ? ' - ' + event.stage : ''}</div>`;
                        html += `<div class="carousel-container" data-carousel="${group.sport}-${group.gender}-${event.event}">`;
                        html += `<div class="carousel-wrapper">`;
                        
                        event.highlights.forEach(highlight => {
                            html += `<div class="result-card">`;
                            html += `<div class="h2h-match">`;
                            
                            // SGP Player
                            html += `<div class="player">`;
                            html += `<div class="player-name">${highlight.athlete_name || 'SGP'}</div>`;
                            html += `<div class="player-score">${highlight.score_sgp || '-'}</div>`;
                            html += `</div>`;
                            
                            html += `<div class="vs-divider">VS</div>`;
                            
                            // Opponent
                            html += `<div class="player">`;
                            html += `<div class="player-name">${highlight.competitor_name || 'Opponent'}</div>`;
                            html += `<div class="player-country">${highlight.competitor_country || ''}</div>`;
                            html += `<div class="player-score">${highlight.score_competitor || '-'}</div>`;
                            html += `</div>`;
                            
                            // Medal
                            if (highlight.medals) {
                                const medal = highlight.medals.toLowerCase();
                                if (medal.includes('gold')) {
                                    html += `<span class="medal-icon">ðŸ¥‡</span>`;
                                } else if (medal.includes('silver')) {
                                    html += `<span class="medal-icon">ðŸ¥ˆ</span>`;
                                } else if (medal.includes('bronze')) {
                                    html += `<span class="medal-icon">ðŸ¥‰</span>`;
                                }
                            }
                            
                            html += `</div>`;
                            html += `</div>`;
                        });
                        
                        html += `</div>`;
                        html += `<button class="carousel-nav prev" onclick="moveCarousel('${group.sport}-${group.gender}-${event.event}', -1)">â€¹</button>`;
                        html += `<button class="carousel-nav next" onclick="moveCarousel('${group.sport}-${group.gender}-${event.event}', 1)">â€º</button>`;
                        html += `</div>`;
                    });
                    
                    html += `</div>`;
                });
            }
            
            // Render Non-H2H highlights
            if (data.non_h2h_groups && data.non_h2h_groups.length > 0) {
                data.non_h2h_groups.forEach(group => {
                    html += `<div class="section">`;
                    html += `<div class="title">${group.sport}</div>`;
                    html += `<div class="subtitle">${group.gender}</div>`;
                    
                    group.events.forEach(event => {
                        html += `<div class="event">${event.event}${event.stage ? ' - ' + event.stage : ''}</div>`;
                        html += `<div class="carousel-container" data-carousel="${group.sport}-${group.gender}-${event.event}">`;
                        html += `<div class="carousel-wrapper">`;
                        
                        event.highlights.forEach(highlight => {
                            html += `<div class="result-card">`;
                            html += `<div class="non-h2h-result">`;
                            html += `<div class="athlete-info">`;
                            html += `<div class="athlete-name">${highlight.athlete_name || ''}</div>`;
                            html += `</div>`;
                            html += `<div class="result-value">`;
                            
                            if (highlight.timing_sgp) {
                                html += highlight.timing_sgp;
                            } else if (highlight.score_sgp) {
                                html += highlight.score_sgp;
                            }
                            
                            if (highlight.pb_nr) {
                                html += `<span class="pb-badge">${highlight.pb_nr}</span>`;
                            }
                            
                            html += `</div>`;
                            
                            // Medal
                            if (highlight.medals) {
                                const medal = highlight.medals.toLowerCase();
                                if (medal.includes('gold')) {
                                    html += `<span class="medal-icon">ðŸ¥‡</span>`;
                                } else if (medal.includes('silver')) {
                                    html += `<span class="medal-icon">ðŸ¥ˆ</span>`;
                                } else if (medal.includes('bronze')) {
                                    html += `<span class="medal-icon">ðŸ¥‰</span>`;
                                }
                            }
                            
                            html += `</div>`;
                            html += `</div>`;
                        });
                        
                        html += `</div>`;
                        html += `<button class="carousel-nav prev" onclick="moveCarousel('${group.sport}-${group.gender}-${event.event}', -1)">â€¹</button>`;
                        html += `<button class="carousel-nav next" onclick="moveCarousel('${group.sport}-${group.gender}-${event.event}', 1)">â€º</button>`;
                        html += `</div>`;
                    });
                    
                    html += `</div>`;
                });
            }
            
            if (!html) {
                html = '<div class="error">No highlights found</div>';
            }
            
            container.innerHTML = html;
            initializeCarousels();
        }
        
        function initializeCarousels() {
            // Initialize carousel positions
            const carousels = document.querySelectorAll('.carousel-container');
            carousels.forEach(carousel => {
                const wrapper = carousel.querySelector('.carousel-wrapper');
                const cards = wrapper.querySelectorAll('.result-card');
                
                if (cards.length <= 2) {
                    // Hide navigation if 2 or fewer cards
                    carousel.querySelectorAll('.carousel-nav').forEach(btn => btn.style.display = 'none');
                }
            });
        }
        
        function moveCarousel(carouselId, direction) {
            const carousel = document.querySelector(`[data-carousel="${carouselId}"]`);
            if (!carousel) return;
            
            const wrapper = carousel.querySelector('.carousel-wrapper');
            const cards = wrapper.querySelectorAll('.result-card');
            if (cards.length === 0) return;
            
            const cardWidth = cards[0].offsetWidth + 15; // Including gap
            const visibleCards = 2;
            const totalCards = cards.length;
            const maxPosition = Math.max(0, -(totalCards - visibleCards) * cardWidth);
            
            // Get current position
            const transform = wrapper.style.transform || 'translateX(0px)';
            const match = transform.match(/translateX\((-?\d+)px\)/);
            let currentPosition = match ? parseInt(match[1]) : 0;
            
            // Calculate new position
            currentPosition += direction * cardWidth * visibleCards;
            
            // Clamp position
            if (currentPosition > 0) {
                currentPosition = 0;
            } else if (currentPosition < maxPosition) {
                currentPosition = maxPosition;
            }
            
            wrapper.style.transform = `translateX(${currentPosition}px)`;
            
            // Update navigation buttons
            const prevBtn = carousel.querySelector('.carousel-nav.prev');
            const nextBtn = carousel.querySelector('.carousel-nav.next');
            
            if (prevBtn) prevBtn.disabled = currentPosition >= 0;
            if (nextBtn) nextBtn.disabled = currentPosition <= maxPosition;
        }
        
        // Load highlights on page load
        loadHighlights();
    </script>
</body>
</html>

